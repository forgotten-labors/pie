fs           = require "node-fs"
path         = require "path"
CoffeeScript = require "coffee-script"

# build target for coffeescript files
map "build_coffee",
    "src/**/*.coffee",
    (src) -> src.replace(/^src\/(.+)\.coffee$/, "lib/pie/$1.js"),
    (src, dest, cb) ->
      console.log "Compiling", src
      fs.readFile src, (err, code) ->
        return cb(err) if err
        try
          res = CoffeeScript.compile(code.toString(), {})
          fs.mkdirSync path.dirname(dest), 0o0755, true
          fs.writeFile dest, res, cb
        catch err
          cb(err)
